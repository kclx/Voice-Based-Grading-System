# 语音判卷系统 (Voice-Based Grading System)

自动语音识别评分系统，让老师可以通过语音输入学生成绩，系统自动更新CSV文件。

## 功能特点

- **连续语音识别**: 系统持续监听，无需手动触发，自然流畅
- **智能姓名匹配**: 四级匹配策略处理同音字和发音偏差
  - 精确匹配 (杨洋 = 杨洋)
  - 拼音精确匹配 (yangyang = 杨洋)
  - **拼音包含匹配** (yangy 包含于 yangyang, 支持部分输入)
  - 拼音模糊匹配 (yanyang ≈ yangyang, 编辑距离 ≤ 2)
- **噪声词过滤**: 自动过滤语音识别中的常见干扰词（"同学"、"证券"等）
- **中文数字支持**: 自动转换中文数字 ("十八" → 18)
- **容错解析**: 支持不完整输入，只说"对"或"错"其中一个即可
- **实时反馈**: 每次输入后立即显示结果
- **数据安全**: 启动时自动备份，每次更新立即保存
- **容错设计**: 识别失败不会中断系统运行

## 系统要求

- Python 3.10+
- 互联网连接 (Google 语音识别 API)
- 麦克风设备
- macOS/Linux/Windows

## 安装步骤

### 1. 克隆或下载项目

```bash
cd voice_marking
```

### 2. 激活虚拟环境

```bash
# macOS/Linux
source .venv/bin/activate

# Windows
.venv\Scripts\activate
```

### 3. 安装依赖

```bash
pip install -r requirements.txt
```

**macOS 用户注意**: 如果 `pyaudio` 安装失败，先安装 `portaudio`:
```bash
brew install portaudio
pip install pyaudio
```

**Linux 用户注意**:
```bash
sudo apt-get install python3-pyaudio portaudio19-dev
pip install pyaudio
```

### 4. 准备学生名单

编辑 `students.csv` 文件，添加实际的学生姓名:

```csv
name,correct,wrong
张三,0,0
李四,0,0
王小明,0,0
```

**重要**:
- 第一行必须是 `name,correct,wrong`
- 每个学生一行
- `correct` 和 `wrong` 列初始值可以是 0 或留空

## 使用方法

### 启动系统

```bash
python main.py
```

系统启动后会显示:

```
============================================================
语音评分系统已启动
============================================================
学生总数: 10
当前统计 - 对: 0, 错: 0

说话格式: 姓名 + 对/正确 + 数字 + 错/错误 + 数字
例如: 杨洋 对 18 错 2

按 Ctrl+C 停止
============================================================
```

### 录入成绩

按照以下格式说话:

**标准格式**: `姓名 + 对/正确 + 数字 + 错/错误 + 数字`

**示例**:
- "杨洋 对 18 错 2"
- "张三 正确 20 错误 0"
- "李四 对 十五 错 五" (支持中文数字)
- "王小明 对 17" (只说对的数量，错误自动为0)
- "刘晓红 错 7" (只说错的数量，正确自动为0)

### 系统反馈

**成功**:
```
✓ 杨洋: 对 18, 错 2
```

**拼音匹配**:
```
✓ 杨洋: 对 18, 错 2
  (匹配方式: pinyin_exact)
```

**姓名不明确** (多个同音名):
```
⚠️  姓名不明确: '杨洋'
    可能是: 杨洋, 阳阳, 羊羊
    请说完整姓名
```

**学生不存在**:
```
⚠️  未找到学生: '张小三'
    请确认姓名后重试
```

**格式错误**:
```
⚠️  无法识别格式: 杨洋18错2
    期望格式: 姓名 + 对/正确 + 数字 + 错/错误 + 数字
```

### 停止系统

按 `Ctrl+C` 停止，系统会显示统计信息:

```
正在停止...

============================================================
系统已停止
============================================================
处理总数: 25
成功更新: 23
匹配失败: 2

最终统计 - 对: 387, 错: 63
============================================================
```

## 文件说明

```
voice_marking/
├── config.py              # 配置文件 (参数调优)
├── main.py                # 主程序入口
├── requirements.txt       # Python 依赖
├── students.csv           # 学生名单和成绩
├── src/
│   ├── speech.py          # 语音识别模块
│   ├── parser.py          # 文本解析模块
│   ├── name_matcher.py    # 姓名匹配模块
│   ├── csv_updater.py     # CSV 更新模块
│   └── utils.py           # 工具函数
└── logs/
    └── voice_marking.log  # 运行日志 (自动生成)
```

## 配置参数

可以在 `config.py` 中调整以下参数:

### 语音识别参数

```python
ENERGY_THRESHOLD = 1000      # 声音能量阈值 (环境噪音大时增加，默认1000)
PAUSE_THRESHOLD = 2          # 停顿时长 (秒，增加到2秒避免截断)
PHRASE_TIME_LIMIT = 5        # 单句最长时间 (秒)
```

### 姓名匹配参数

```python
LEVENSHTEIN_THRESHOLD = 2    # 模糊匹配距离 (1=严格, 2=宽松，默认2)
```

### 解析关键词

```python
CORRECT_KEYWORDS = ["对", "正确"]  # 可添加其他关键词
WRONG_KEYWORDS = ["错", "错误"]
```

## 常见问题

### 1. 麦克风无法识别

**症状**: 启动时报错 "Microphone not available"

**解决**:
- 检查麦克风是否连接
- macOS: 系统偏好设置 → 安全性与隐私 → 麦克风 → 允许终端访问
- Linux: 检查 ALSA/PulseAudio 配置
- 运行测试: `python -m speech_recognition`

### 2. 语音识别不准确

**症状**: 经常识别错误或无法识别

**解决**:
- 说话清晰，语速适中
- 减少环境噪音
- 调整 `config.py` 中的 `ENERGY_THRESHOLD`
- 靠近麦克风 (30-50cm 距离)

### 3. 姓名匹配失败

**症状**: 明明有这个学生，但总是 "未找到学生"

**解决**:
- 检查 `students.csv` 中姓名拼写
- 尝试说全名 (如 "王小明" 而非 "小明")
- 查看 `logs/voice_marking.log` 了解识别的原始文本
- 增加 `LEVENSHTEIN_THRESHOLD` 到 2

### 4. 网络连接问题

**症状**: "Could not request results from speech service"

**解决**:
- 检查网络连接
- Google Speech API 需要互联网
- 考虑使用离线方案 (Whisper, 需修改代码)

### 5. CSV 更新失败

**症状**: "更新失败: 张三"

**解决**:
- 检查 `students.csv` 文件权限
- 确认文件未被其他程序占用 (如 Excel)
- 查看 `logs/voice_marking.log` 详细错误

## 数据备份

系统会在每次启动时自动创建备份:

```
students.csv.backup_20231215_143052
```

如需恢复:
```bash
cp students.csv.backup_20231215_143052 students.csv
```

## 日志查看

所有操作都记录在 `logs/voice_marking.log`:

```bash
# 查看最近 50 行日志
tail -50 logs/voice_marking.log

# 实时监控日志
tail -f logs/voice_marking.log
```

## 进阶用法

### 修改匹配策略

如果班级有大量同音名学生，可以调整匹配策略:

在 `src/name_matcher.py` 中修改 `find_match()` 方法，例如:
- 优先级调整
- 增加声母韵母匹配
- 自定义相似度算法

### 支持多个班级

创建多个 CSV 文件:

```bash
python main.py  # 默认使用 students.csv
```

修改 `config.py`:
```python
CSV_FILE_PATH = "class_1A.csv"  # 切换班级
```

### 批量导入

从 Excel 转换为 CSV:

1. Excel 中整理好 `name`, `correct`, `wrong` 三列
2. 另存为 → CSV UTF-8 格式
3. 保存为 `students.csv`

## 技术细节

### 姓名匹配算法

系统采用四级匹配策略，按优先级依次尝试：

1. **精确匹配**: 字符串完全相同
2. **拼音精确匹配**: 使用 `pypinyin` 转换后完全相同
3. **拼音包含匹配** (新增): 支持部分拼音输入
   - "yang" 可匹配 "yangyang" (杨洋)
   - "wangxiao" 可匹配 "wangxiaoming" (王小明)
4. **拼音模糊匹配**: Levenshtein 编辑距离 ≤ 2
   - 可匹配: "杨洋" ↔ "羊杨" (距离=1)
   - 可匹配: "yangyang" ↔ "yanyang" (距离=1)

**噪声词过滤**: 自动移除语音识别中的干扰词
- 过滤词列表: "证券", "队伍", "实物", "成绩", "同学", "同学的", "的"
- 示例: "杨洋同学 对 18 错 2" → 自动处理为 "杨洋 对 18 错 2"

### 数据流

```
麦克风 → 语音识别 → 文本解析 → 姓名匹配 → CSV更新 → 用户反馈
```

### 线程安全

- CSV 更新使用线程锁 (`threading.Lock`)
- 支持高频率连续输入
- 防止数据竞争和损坏

## 许可证

MIT License

## 反馈与支持

如有问题或建议，请:
1. 查看 `logs/voice_marking.log` 日志
2. 检查本 README 的常见问题部分
3. 提交 Issue (如果项目开源)

## 更新日志

### v1.1.0 (2025-12-23)
- **新增**: 拼音包含匹配，支持部分拼音输入识别
- **新增**: 噪声词自动过滤功能
- **改进**: 解析器支持不完整输入（只说对或错其中一个）
- **优化**: 放宽模糊匹配阈值至2，提高识别成功率
- **优化**: 调整语音参数，更适应教室环境
  - ENERGY_THRESHOLD: 4000 → 1000
  - PAUSE_THRESHOLD: 0.8s → 2s

### v1.0.0 (2024)
- 初始版本
- 连续语音识别
- 三级姓名匹配
- 中文数字支持
- 自动备份
- 实时反馈
